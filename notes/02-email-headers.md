# 02 — Email Headers: Reading and Analyzing Source Headers

## Objectives
- Understand common header fields and their meaning.
- Learn how to trace message path using Received headers.
- Identify authentication headers (SPF, DKIM, DMARC) and common spoofing indicators.

## Common header fields
- **From:** Displayed sender. Can be easily spoofed by attackers.
- **Sender:** Actual sender agent when different from the From address.
- **To / Cc / Bcc:** Recipient fields (Bcc is not visible in final delivered headers but used during transport).
- **Date:** When the message was generated according to the sender's client. Can be forged.
- **Message-ID:** Unique identifier for the message; often includes originating host info.
- **Return-Path:** Bounce address used by MTAs.
- **Received:** Chain of MTAs that the message traversed. Each MTA prepends a Received header — read bottom-up to see origin.
- **Authentication-Results:** Results added by receiving servers after checking SPF/DKIM/DMARC.
- **DKIM-Signature:** Cryptographic signature over parts of the message added by the sender's domain.
- **X- headers:** Custom headers added by mail gateways, spam filters, or mail clients (e.g., X-Spam-Status, X-Mailer).

## Tracing the path: Received headers
- Received headers are added by each MTA in the path; **read from bottom to top** to follow the earliest hop (origin) to the final delivery.
- Typical Received format: `Received: from <hostname> ([IP]) by <receiving-host> with ESMTP id <id>; <timestamp>`
- Look for:
  - Private IP addresses or local hostnames that don't match the sending domain.
  - Hops from known malicious ranges / hosting providers used for spam.
  - Time inconsistencies (e.g., timestamps that do not line up or are in different timezones).

## Authentication: SPF, DKIM, DMARC
- **SPF (Sender Policy Framework)**: Uses DNS TXT to declare allowed sending IPs for a domain.
  - Check `Authentication-Results` or perform an SPF check for the envelope sender (MAIL FROM).
  - Typical results: `pass`, `fail`, `softfail`, `neutral`, `none`.
- **DKIM (DomainKeys Identified Mail)**:
  - DKIM-Signature includes selector and domain; the receiver validates signature using DNS-published public key.
  - A valid DKIM means selected headers and body hash match the signature — but a valid DKIM from a *compromised* domain is still malicious.
- **DMARC (Domain-based Message Authentication, Reporting & Conformance)**:
  - DMARC ties SPF/DKIM to the visible From: domain and defines policy (none/quarantine/reject).
  - DMARC reports can be used for telemetry and to detect abuse.

## Red flags in headers
- `From` domain does not align with `Return-Path` or `Mail From`.
- Authentication-Results show SPF/DKIM `fail` but email is delivered.
- Missing or malformed Received chain (e.g., only a few hops with suspicious origins).
- Message-ID that appears autogenerated by unknown hosting provider or free service.
- X-Mailer or User-Agent that suggests mass-mailing software for a message purporting to be from a human sender.

## Example: Minimal header analysis (conceptual)
1. Extract raw headers from `.eml`.
2. Read Received headers bottom-up to find earliest hop.
3. Check Authentication-Results: note SPF/DKIM/DMARC results.
4. Compare From: domain with Return-Path / DKIM domain for alignment.
5. Resolve IPs in Received headers to ASN / owner to spot suspicious providers.

## Tools & commands
- `grep`, `sed`, `awk` for quick extraction.
- Python: `email` module or `mailparser` library.
- `dig TXT` / `nslookup` to inspect SPF/DKIM (DNS).
- Online header analyzers for quick triage (use only with non-sensitive headers).
